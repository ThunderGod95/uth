{{- $currentId := 0 -}} {{- $currentTitle := .Title -}} {{- $matches :=
findRESubmatch `(?m)^#\s*Chapter\s+(\d+):\s*(.*)$` .RawContent 1 -}} {{- if
$matches -}} {{- $match := index $matches 0 -}} {{- $currentId = int (index
$match 1) -}} {{- $currentTitle = index $match 2 -}} {{- end -}} {{- $chapters
:= slice -}} {{- range where .Site.RegularPages "Section" "chapters" -}} {{-
$cId := 0 -}} {{- $cMatches := findRESubmatch `(?m)^#\s*Chapter\s+(\d+)`
.RawContent 1 -}} {{- if $cMatches -}} {{- $cId = int (index (index $cMatches 0)
1) -}} {{- $chapters = $chapters | append (dict "id" $cId "url" .RelPermalink)
-}} {{- end -}} {{- end -}} {{- $chapters = sort $chapters "id" "asc" -}} {{-
$prevId := "" -}} {{- $nextId := "" -}} {{- $prevUrl := "" -}} {{- $nextUrl :=
"" -}} {{- $currentIndex := -1 -}} {{- range $index, $element := $chapters -}}
{{- if eq $element.id $currentId -}} {{- $currentIndex = $index -}} {{- end -}}
{{- end -}} {{- if gt $currentIndex 0 -}} {{- $prevItem := index $chapters (sub
$currentIndex 1) -}} {{- $prevId = $prevItem.id -}} {{- $prevUrl = $prevItem.url
-}} {{- end -}} {{- if lt (add $currentIndex 1) (len $chapters) -}} {{-
$nextItem := index $chapters (add $currentIndex 1) -}} {{- $nextId =
$nextItem.id -}} {{- $nextUrl = $nextItem.url -}} {{- end -}}

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ $currentTitle }} | {{ .Site.Title }}</title>
        <meta name="theme-color" content="#333333" />

        <link
            rel="icon"
            type="image/png"
            href="{{ `icons/favicon-96x96.png` | relURL }}"
            sizes="96x96"
        />
        <link
            rel="icon"
            type="image/svg+xml"
            href="{{ `assets/icons/favicon.svg` | relURL }}"
        />
        <link rel="shortcut icon" href="{{ `icons/favicon.ico` | relURL }}" />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="{{ `icons/apple-touch-icon.png` | relURL }}"
        />
        <meta name="apple-mobile-web-app-title" content="{{ $currentTitle }}" />
        {{ with .OutputFormats.Get "WebAppManifest" }}
        <link rel="manifest" href="{{ .Permalink }}" />
        {{ end }} {{ partial "fonts.html" }} {{ $styles := resources.Get
        "css/common.css" | minify | fingerprint }}
        <link
            rel="stylesheet"
            href="{{ $styles.RelPermalink }}"
            integrity="{{ $styles.Data.Integrity }}"
        />

        {{ $chapter := resources.Get "css/chapter.css" | minify | fingerprint }}
        <link
            rel="stylesheet"
            href="{{ $chapter.RelPermalink }}"
            integrity="{{ $chapter.Data.Integrity }}"
        />

        {{ $highlights := resources.Get "css/highlights.css" | minify |
        fingerprint }}
        <link
            rel="stylesheet"
            href="{{ $highlights.RelPermalink }}"
            integrity="{{ $highlights.Data.Integrity }}"
        />
        {{ partial "theme-loader.html" }}
    </head>

    <body>
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>

        <div id="sentinel"></div>

        <div class="sticky-bar" id="topNav">
            <nav class="chapter-nav">
                {{ if $prevUrl }}
                <a class="nav-link nav-prev" href="{{ $prevUrl }}"
                    >← Previous</a
                >
                {{ else }}
                <a class="nav-link nav-prev disabled">← Previous</a>
                {{ end }}

                <a
                    class="nav-link nav-toc"
                    href="{{ `/myriadpaths/` | relURL }}"
                    >Index</a
                >

                {{ if $nextUrl }}
                <a class="nav-link nav-next" href="{{ $nextUrl }}">Next →</a>
                {{ else }}
                <a class="nav-link nav-next disabled">Next →</a>
                {{ end }}
            </nav>
        </div>

        <div class="audio-toolbar-wrapper">
            <div class="audio-toolbar">
                <button
                    id="toggleAudio"
                    class="audio-main-btn"
                    aria-label="Play Audio"
                >
                    <svg id="icon-play" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                    <svg
                        id="icon-pause"
                        style="display: none"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                    </svg>
                    <span id="audio-status-text">Listen</span>
                </button>

                <div class="audio-separator"></div>

                <button
                    id="toggleAudioSettings"
                    class="audio-settings-btn"
                    aria-label="Audio Options"
                >
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"
                        />
                    </svg>
                </button>
            </div>

            <div id="audioSettingsMenu" class="audio-menu">
                <div class="setting-item">
                    <div class="setting-header">
                        <label>Voice</label>
                    </div>
                    <div class="select-wrapper">
                        <select id="input-voice"></select>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-header">
                        <label>Speed</label>
                        <span id="rate-val" class="value-display">1x</span>
                    </div>
                    <input
                        type="range"
                        id="input-rate"
                        min="0.5"
                        max="2"
                        step="0.1"
                        value="1"
                    />
                </div>

                <div class="setting-item">
                    <div class="setting-header">
                        <label>Pitch</label>
                        <span id="pitch-val" class="value-display">1</span>
                    </div>
                    <input
                        type="range"
                        id="input-pitch"
                        min="0"
                        max="2"
                        step="0.1"
                        value="1"
                    />
                </div>
            </div>
        </div>

        <main id="content">{{ .Content }}</main>

        <div style="text-align: center">
            <a
                href="https://discord.gg/EmEJmvwYUS"
                class="discord-btn"
                target="_blank"
                rel="noopener noreferrer"
            >
                <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="white"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        d="M20.317 4.3698a19.7913 19.7913 0 0 0-4.8851-1.5152.0741.0741 0 0 0-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 0 0-.0785-.037 19.7363 19.7363 0 0 0-4.8852 1.515.0699.0699 0 0 0-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 0 0 .0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 0 0 .0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 0 0-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 0 1-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 0 1 .0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 0 1 .0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 0 1-.0066.1276 12.2986 12.2986 0 0 1-1.873.8914.0766.0766 0 0 0-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 0 0 .0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 0 0 .0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 0 0-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.419-2.1568 2.419z"
                    />
                </svg>
                Join the conversation on Discord
            </a>
        </div>

        <nav class="chapter-nav bottom-nav">
            {{ if $prevUrl }}
            <a class="nav-link nav-prev" href="{{ $prevUrl }}">← Previous</a>
            {{ else }}
            <a class="nav-link nav-prev disabled">← Previous</a>
            {{ end }}

            <a class="nav-link nav-toc" href="{{ `/myriadpaths/` | relURL }}"
                >Index</a
            >

            {{ if $nextUrl }}
            <a class="nav-link nav-next" href="{{ $nextUrl }}">Next →</a>
            {{ else }}
            <a class="nav-link nav-next disabled">Next →</a>
            {{ end }}
        </nav>

        <footer class="page-footer">Translated with ❤️ by Thundergod95</footer>

        <div class="fab-container">
            <div class="settings-menu" id="settingsMenu">
                <div class="setting-item">
                    <div class="setting-header">
                        <label>Font Size</label>
                        <span id="fs-val" class="value-display">18px</span>
                    </div>
                    <input
                        type="range"
                        id="input-fontsize"
                        min="14"
                        max="32"
                        value="18"
                    />
                </div>

                <div class="setting-item">
                    <div class="setting-header">
                        <label>Line Height</label>
                        <span id="lh-val" class="value-display">1.6</span>
                    </div>
                    <input
                        type="range"
                        id="input-lineheight"
                        min="1.2"
                        max="2.4"
                        step="0.1"
                        value="1.6"
                    />
                </div>

                <div class="setting-item">
                    <div class="setting-header">
                        <label>Letter Spacing</label>
                        <span id="spacing-val" class="value-display">0px</span>
                    </div>
                    <input
                        type="range"
                        id="input-spacing"
                        min="-1"
                        max="3"
                        step="0.5"
                        value="0"
                    />
                </div>
                <div class="setting-item">
                    <div class="setting-header">
                        <label for="input-font">Typeface</label>
                    </div>
                    <div class="select-wrapper">
                        <select id="input-font">
                            <option value="'Open Sans', sans-serif">
                                Open Sans (Sans)
                            </option>
                            <option value="'Merriweather Sans', sans-serif">
                                Merriweather Sans (Sans)
                            </option>
                            <option value="'Nunito Sans', sans-serif">
                                Nunito Sans (Sans)
                            </option>
                            <option value="'Prompt', sans-serif">
                                Prompt (Sans)
                            </option>
                            <option value="'Ubuntu', sans-serif">
                                Ubuntu (Sans)
                            </option>
                            <option value="'Ysabeau Office', sans-serif">
                                Ysabeau Office (Sans)
                            </option>

                            <option value="'Baskervville', serif">
                                Baskervville (Serif)
                            </option>
                            <option value="'Bitter', serif">
                                Bitter (Serif)
                            </option>
                            <option value="'EB Garamond', serif">
                                EB Garamond (Serif)
                            </option>
                            <option value="'Literata', serif">
                                Literata (Serif)
                            </option>
                            <option value="'Merriweather', serif">
                                Merriweather (Serif)
                            </option>

                            <option value="'Coming Soon', cursive">
                                Coming Soon
                            </option>
                            <option value="'Caveat', cursive">Caveat</option>
                            <option value="'Indie Flower', cursive">
                                Indie Flower
                            </option>
                            <option value="'Patrick Hand', cursive">
                                Patrick Hand
                            </option>
                        </select>
                    </div>
                </div>
                <div class="setting-row">
                    <div class="setting-item">
                        <div class="setting-header">
                            <label>Paragraph Style</label>
                        </div>
                        <div class="segmented-control" id="para-style-btns">
                            <button
                                class="segment-btn active"
                                data-style="block"
                                aria-label="Block Style"
                            >
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"
                                    />
                                </svg>
                            </button>
                            <button
                                class="segment-btn"
                                data-style="indent"
                                aria-label="Indented Style"
                            >
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M10 6h10v2H10zm-6 5h16v2H4zm0 5h16v2H4z"
                                    />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-header">
                        <label>Theme</label>
                    </div>
                    <div class="theme-selector">
                        <button
                            class="theme-btn"
                            data-theme="light"
                            style="background-color: #fdfdfd"
                            aria-label="Light"
                        ></button>
                        <button
                            class="theme-btn"
                            data-theme="sepia"
                            style="background-color: #f4ecd8"
                            aria-label="Sepia"
                        ></button>
                        <button
                            class="theme-btn"
                            data-theme="dark"
                            style="background-color: #222222"
                            aria-label="Dark"
                        ></button>

                        <button
                            class="theme-btn"
                            data-theme="midnight"
                            style="background-color: #2b323b"
                            aria-label="Midnight"
                        ></button>
                        <button
                            class="theme-btn"
                            data-theme="forest"
                            style="background-color: #e8f5e9"
                            aria-label="Forest"
                        ></button>
                        <button
                            class="theme-btn"
                            data-theme="amoled"
                            style="
                                background-color: #000000;
                                border: 1px solid #444;
                            "
                            aria-label="AMOLED"
                        ></button>
                    </div>
                </div>
            </div>

            <button
                class="settings-btn"
                id="toggleHighlightsList"
                aria-label="View All Highlights"
                style="margin-bottom: 12px"
            >
                <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path
                        d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
                    ></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
            </button>

            <button
                class="settings-btn"
                id="toggleSettings"
                aria-label="Settings"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    height="24"
                    width="24"
                    viewBox="0 0 640 640"
                >
                    <path
                        d="M259.1 73.5C262.1 58.7 275.2 48 290.4 48L350.2 48C365.4 48 378.5 58.7 381.5 73.5L396 143.5C410.1 149.5 423.3 157.2 435.3 166.3L503.1 143.8C517.5 139 533.3 145 540.9 158.2L570.8 210C578.4 223.2 575.7 239.8 564.3 249.9L511 297.3C511.9 304.7 512.3 312.3 512.3 320C512.3 327.7 511.8 335.3 511 342.7L564.4 390.2C575.8 400.3 578.4 417 570.9 430.1L541 481.9C533.4 495 517.6 501.1 503.2 496.3L435.4 473.8C423.3 482.9 410.1 490.5 396.1 496.6L381.7 566.5C378.6 581.4 365.5 592 350.4 592L290.6 592C275.4 592 262.3 581.3 259.3 566.5L244.9 496.6C230.8 490.6 217.7 482.9 205.6 473.8L137.5 496.3C123.1 501.1 107.3 495.1 99.7 481.9L69.8 430.1C62.2 416.9 64.9 400.3 76.3 390.2L129.7 342.7C128.8 335.3 128.4 327.7 128.4 320C128.4 312.3 128.9 304.7 129.7 297.3L76.3 249.8C64.9 239.7 62.3 223 69.8 209.9L99.7 158.1C107.3 144.9 123.1 138.9 137.5 143.7L205.3 166.2C217.4 157.1 230.6 149.5 244.6 143.4L259.1 73.5zM320.3 400C364.5 399.8 400.2 363.9 400 319.7C399.8 275.5 363.9 239.8 319.7 240C275.5 240.2 239.8 276.1 240 320.3C240.2 364.5 276.1 400.2 320.3 400z"
                    />
                </svg>
            </button>
        </div>

        <div id="highlight-toolbar" style="display: none">
            <div class="hl-group">
                <button
                    class="hl-btn-color hl-btn-yellow"
                    data-color="yellow"
                    title="Yellow"
                ></button>
                <button
                    class="hl-btn-color hl-btn-green"
                    data-color="green"
                    title="Green"
                ></button>
                <button
                    class="hl-btn-color hl-btn-blue"
                    data-color="blue"
                    title="Blue"
                ></button>
                <button
                    class="hl-btn-color hl-btn-red"
                    data-color="red"
                    title="Red"
                ></button>
            </div>

            <div class="hl-divider"></div>

            <div class="hl-group">
                <button class="icon-btn note-btn" title="Add Note">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path
                            d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                        ></path>
                        <path
                            d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                        ></path>
                    </svg>
                </button>
                <button class="icon-btn delete-btn" title="Remove Highlight">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path
                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                        ></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="modal-overlay" id="noteOverlay">
            <div class="modal" id="noteModal">
                <div class="modal-header">
                    <h3>Highlight Note</h3>
                </div>
                <textarea
                    id="noteInput"
                    placeholder="Add your thoughts here..."
                ></textarea>
                <div class="modal-actions">
                    <button class="ui-button btn-secondary" id="cancelNote">
                        Cancel
                    </button>
                    <button class="ui-button btn-primary" id="saveNote">
                        Save Note
                    </button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="overviewOverlay">
            <div class="modal overview-modal">
                <div class="modal-header">
                    <h3>My Highlights & Notes</h3>
                    <button
                        class="icon-btn"
                        id="closeOverview"
                        aria-label="Close"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            width="24"
                            height="24"
                            stroke="currentColor"
                            stroke-width="2"
                            fill="none"
                        >
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="overview-controls">
                    <div class="search-wrapper">
                        <svg
                            class="search-icon"
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input
                            type="text"
                            id="overviewSearch"
                            placeholder="Search text or notes..."
                        />
                    </div>

                    <div class="sort-group">
                        <button
                            class="icon-btn sort-btn active"
                            data-value="chapter"
                            title="Group by Chapter"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <path
                                    d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"
                                ></path>
                                <path
                                    d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                                ></path>
                            </svg>
                        </button>
                        <button
                            class="icon-btn sort-btn"
                            data-value="newest"
                            title="Newest First"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <polyline points="19 12 12 19 5 12"></polyline>
                            </svg>
                        </button>
                        <button
                            class="icon-btn sort-btn"
                            data-value="oldest"
                            title="Oldest First"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <line x1="12" y1="19" x2="12" y2="5"></line>
                                <polyline points="5 12 12 5 19 12"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="overview-content" id="overviewContent"></div>
            </div>
        </div>

        <script>
            const PREV_CHAPTER_NUM = "{{ $prevId }}";
            const NEXT_CHAPTER_NUM = "{{ $nextId }}";
            const CHAPTER_TITLE = `{{ $currentTitle }}`;
            const CHAPTER_NUM = {{ $currentId }};
        </script>

        {{ $floatingCore := resources.Get "js/vendor/floating-ui/core.js" |
        minify | fingerprint }}
        <script src="{{ $floatingCore.RelPermalink }}"></script>

        {{ $floatingDom := resources.Get "js/vendor/floating-ui/dom.js" | minify
        | fingerprint }}
        <script src="{{ $floatingDom.RelPermalink }}"></script>

        {{- $chapterJs := resources.Get "js/chapter.js" |
        resources.ExecuteAsTemplate "js/chapter.js" . | minify | fingerprint -}}
        <script src="{{ $chapterJs.RelPermalink }}"></script>
        {{ $highlightJs := resources.Get "js/highlight.js" | minify |
        fingerprint }}
        <script src="{{ $highlightJs.RelPermalink }}"></script>

        {{ $audioJs := resources.Get "js/audio.js" | minify | fingerprint }}
        <script src="{{ $audioJs.RelPermalink }}"></script>

        <script>
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("{{ `sw.js` | relURL }}")
                        .then((reg) =>
                            console.log("Service Worker registered!", reg),
                        )
                        .catch((err) =>
                            console.log("Registration failed:", err),
                        );
                });
            }
        </script>
    </body>
</html>
